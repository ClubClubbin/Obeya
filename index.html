<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Areas Obeya">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Areas Obeya">

    <title>Areas Assurances - Tableau Obeya</title>

    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        @media print {
            body { margin: 0; padding: 5mm; background: white; }
            .no-print { display: none !important; }
            .client-slot { cursor: default !important; box-shadow: none !important; }
            .col-week { background: white !important; }
            .page-wrapper { width: 100vw !important; transform: none !important; }
            .page-historique { display: none !important; }
            .page-nav { display: none !important; }
            .main-content { width: 100% !important; margin: 0 !important; }
            .mic-container { display: none !important; }
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 0;
            padding-bottom: 80px;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .app-header h1 {
            font-size: 24px;
            color: #2c3e50;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .app-header .subtitle {
            font-size: 13px;
            color: #7f8c8d;
        }
        
        .header-actions {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-btn:active {
            transform: scale(0.95);
        }
        
        .page-wrapper {
            display: flex;
            width: 200vw;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
            min-height: 100vh;
        }
        .page-wrapper.on-historique {
            transform: translateX(-100vw);
        }

        .page {
            width: 100vw;
            flex-shrink: 0;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 25px;
        }

        /* Navigation entre pages */
        .page-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: rgba(44, 62, 80, 0.95);
            padding: 8px 16px;
            border-radius: 30px;
            z-index: 900;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .page-nav-btn {
            background: none;
            border: 2px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.6);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .page-nav-btn.active {
            background: white;
            color: #2c3e50;
            border-color: white;
        }
        .page-nav-btn:not(.active):hover {
            border-color: rgba(255,255,255,0.6);
            color: white;
        }
        /* Indicateur de page (dots) */
        .page-dots {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 8px;
        }
        .page-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .page-dot.active {
            background: white;
            width: 20px;
            border-radius: 4px;
        }
        
        /* ... [Le reste des styles identiques √† la version pr√©c√©dente] ... */
        
        .synthese-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 3px solid #2c3e50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .synthese-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .synthese-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        
        .synthese-date {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .synthese-date input {
            border: none;
            border-bottom: 2px solid #2c3e50;
            background: transparent;
            font-size: 14px;
            width: 60px;
            text-align: center;
            font-family: inherit;
            font-weight: bold;
        }
        
        .synthese-date input.date-full {
            width: 100px;
            font-weight: normal;
        }
        
        .synthese-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .synthese-item input {
            width: 50px;
            border: 2px solid #2c3e50;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            background: #f0f0f0;
        }
        
        .synthese-item input.auto-calc {
            background: #d5f4e6;
            border-color: #27ae60;
            color: #27ae60;
        }
        
        .synthese-item input.historique {
            background: #fff3cd;
            border-color: #f1c40f;
            color: #856404;
        }
        
        .synthese-euro {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }
        
        .time-legend {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            color: #7f8c8d;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .arrow {
            font-size: 20px;
            color: #e74c3c;
        }
        
        .main-table {
            width: 100%;
            border-collapse: collapse;
            border: 3px solid #2c3e50;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table-header {
            background: #2c3e50;
            color: white;
        }
        
        .table-header th {
            padding: 12px 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-right: 1px solid #34495e;
        }
        
        .table-header th:last-child {
            border-right: none;
            background: #c0392b;
        }
        
        .col-status {
            width: 14%;
            background: #ecf0f1;
            font-weight: bold;
            font-size: 10px;
            text-align: left;
            padding: 10px 6px;
            border-right: 2px solid #2c3e50;
            border-bottom: 2px solid #bdc3c7;
            vertical-align: top;
        }
        
        .col-week {
            width: 21.5%;
            border-right: 2px solid #bdc3c7;
            border-bottom: 2px solid #bdc3c7;
            vertical-align: top;
            padding: 8px;
            min-height: 100px;
            background: white;
            transition: background 0.2s;
        }
        
        .col-week:last-child {
            border-right: none;
            background: #fff5f5;
        }
        
        .col-week.drag-over {
            background: #d5f4e6 !important;
            box-shadow: inset 0 0 0 3px #27ae60;
        }
        
        .col-week.read-only {
            background: #f8f9fa;
        }
        
        .status-row-demandes .col-status { 
            background: #fff3cd; 
            border-left: 5px solid #f1c40f;
        }
        .status-row-devis .col-status { 
            background: #cce5ff; 
            border-left: 5px solid #3498db;
        }
        .status-row-envoyes .col-status { 
            background: #e2d4f0; 
            border-left: 5px solid #9b59b6;
        }
        .status-row-signes .col-status { 
            background: #d4edda; 
            border-left: 5px solid #27ae60;
        }
        
        .status-icon {
            font-size: 12px;
            margin-right: 2px;
        }
        
        .status-text {
            font-size: 8px;
            display: block;
            margin-top: 2px;
            color: #555;
            font-weight: normal;
            line-height: 1.2;
        }
        
        .client-slot {
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 70px;
            cursor: grab;
            position: relative;
            transition: all 0.2s;
            touch-action: none;
            user-select: none;
        }
        
        .client-slot:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            border-color: #3498db;
        }
        
        .client-slot.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(3deg) scale(1.05);
            z-index: 1000;
        }
        
        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3px;
        }
        
        .slot-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 11px;
            flex: 1;
            word-break: break-word;
        }
        
        .slot-edit {
            font-size: 10px;
            color: #3498db;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            margin-left: 4px;
        }
        
        .slot-type {
            font-size: 9px;
            color: #7f8c8d;
            background: #ecf0f1;
            padding: 1px 4px;
            border-radius: 3px;
            display: inline-block;
            margin-bottom: 3px;
        }
        
        .slot-dates {
            font-size: 8px;
            color: #7f8c8d;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #ecf0f1;
            line-height: 1.3;
        }
        
        .slot-date-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .slot-date-label {
            font-weight: 600;
            color: #555;
        }
        
        .slot-notes {
            font-size: 9px;
            color: #555;
            font-style: italic;
            margin-top: 3px;
            line-height: 1.2;
        }
        
        .slot-stickers {
            display: flex;
            gap: 3px;
            margin-top: 5px;
            justify-content: flex-end;
            min-height: 12px;
        }
        
        .mini-sticker {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid #333;
        }
        
        .add-slot-btn {
            width: 100%;
            padding: 6px;
            border: 1.5px dashed #bdc3c7;
            background: transparent;
            color: #95a5a6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            margin-top: 5px;
            transition: all 0.2s;
        }
        
        .add-slot-btn:hover {
            border-color: #3498db;
            color: #3498db;
            background: #ebf5fb;
        }
        
        .no-add {
            text-align: center;
            color: #95a5a6;
            font-size: 10px;
            padding: 8px;
            font-style: italic;
        }
        
        .parking-header {
            background: #c0392b;
            color: white;
            padding: 4px;
            border-radius: 4px;
            font-size: 9px;
            text-align: center;
            margin-bottom: 6px;
            font-weight: bold;
        }
        
        .historique-panel {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 20px;
        }
        
        .historique-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .historique-week {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        
        .historique-week-header {
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .historique-week-date {
            font-size: 10px;
            color: #7f8c8d;
        }
        
        .historique-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        
        .historique-stat {
            text-align: center;
            padding: 5px;
            background: white;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .historique-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .historique-stat-label {
            font-size: 9px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .historique-taux {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #bdc3c7;
            font-size: 10px;
            color: #555;
            text-align: center;
        }
        
        .stats-duree-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
        }
        
        .stats-duree-title {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stats-duree-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 15px;
            color: white;
            margin-bottom: 15px;
        }
        
        .stats-duree-header {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            opacity: 0.95;
        }
        
        .stats-duree-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .stats-duree-item {
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }
        
        .stats-duree-value {
            font-size: 18px;
            font-weight: bold;
            display: block;
        }
        
        .stats-duree-label {
            font-size: 9px;
            opacity: 0.9;
            text-transform: uppercase;
        }
        
        .stats-duree-moyenne {
            background: rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
        }
        
        .stats-duree-moyenne-value {
            font-size: 24px;
            font-weight: bold;
            display: block;
        }
        
        .stats-duree-detail {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
        }
        
        .stats-duree-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stats-duree-detail-item:last-child {
            border-bottom: none;
        }
        
        .btn-cloturer {
            width: 100%;
            padding: 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.2s;
        }
        
        .btn-cloturer:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .stickers-bar {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .stickers-title {
            font-size: 13px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .stickers-list {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .sticker-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #555;
        }
        
        .sticker-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        /* Bouton Micro */
        .mic-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .mic-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 4px solid white;
            color: white;
            font-size: 28px;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-appearance: none;
        }
        
        .mic-button:active {
            transform: scale(0.95);
        }
        
        .mic-button.listening {
            animation: pulse-mic 1.5s infinite;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        @keyframes pulse-mic {
            0%, 100% { box-shadow: 0 8px 30px rgba(231, 76, 60, 0.5); transform: scale(1); }
            50% { box-shadow: 0 8px 40px rgba(231, 76, 60, 0.7); transform: scale(1.05); }
        }
        
        .mic-hint {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mic-hint.visible {
            opacity: 1;
        }
        
        /* Modal Voice */
        .voice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }
        
        .voice-modal.active {
            display: flex;
        }
        
        .voice-visualizer {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 30px;
            position: relative;
        }
        
        .voice-waves {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            animation: wave 2s infinite;
        }
        
        @keyframes wave {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .voice-text {
            color: white;
            font-size: 22px;
            text-align: center;
            margin-bottom: 30px;
            min-height: 60px;
            font-weight: 500;
        }
        
        .voice-commands {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
        }
        
        .voice-commands-title {
            color: white;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .voice-command-item {
            color: rgba(255,255,255,0.9);
            font-size: 13px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .voice-command-item:last-child {
            border-bottom: none;
        }
        
        .voice-close {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Modal √âdition */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            color: #555;
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #3498db;
        }
        
        .sticker-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .sticker-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .sticker-option:hover { transform: scale(1.1); }
        .sticker-option.selected { 
            border-color: #2c3e50; 
            box-shadow: 0 0 0 2px white, 0 0 0 4px #2c3e50;
        }
        .sticker-option.selected::after {
            content: "‚úì";
            color: white;
            font-size: 18px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-cancel { background: #95a5a6; color: white; }
        .btn-save { background: #3498db; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        .delete-zone {
            display: none;
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: bold;
            z-index: 1500;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            animation: pulse-delete 1s infinite;
        }
        
        .delete-zone.active {
            display: block;
        }
        
        @keyframes pulse-delete {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #2c3e50;
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .voice-help-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
        }
        
        .voice-help-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .voice-help-item {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
            margin: 6px 0;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            body { padding: 0; padding-bottom: 80px; }
            .page { padding: 10px; }
            .main-content { padding: 15px; overflow-x: auto; }
            .main-table { min-width: 800px; }
            .col-status { width: 120px; }
        }
        
        @media (max-width: 768px) {
            .app-header h1 { font-size: 18px; }
            .synthese-content { gap: 10px; }
            .synthese-item { font-size: 12px; }
            .synthese-item input { width: 40px; font-size: 14px; }
        }
        
        /* Installation PWA prompt */
        .install-prompt {
            display: none;
            position: fixed;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
        }
        
        .install-prompt.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .install-btn {
            background: #27ae60;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Prompt d'installation -->
    <div class="install-prompt" id="installPrompt">
        üì± Installer Areas Obeya
        <button class="install-btn" onclick="installPWA()">Installer</button>
        <button onclick="dismissInstall()" style="background:none;border:none;color:white;font-size:18px;">‚úï</button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Delete Zone -->
    <div class="delete-zone" id="deleteZone">üóëÔ∏è Rel√¢chez pour supprimer</div>

    <!-- Navigation entre pages -->
    <nav class="page-nav no-print" id="pageNav">
        <button class="page-nav-btn active" id="navTableau" onclick="naviguerVers(0)">üìã Tableau</button>
        <div class="page-dots">
            <div class="page-dot active" id="dot0"></div>
            <div class="page-dot" id="dot1"></div>
        </div>
        <button class="page-nav-btn" id="navHistorique" onclick="naviguerVers(1)">üìö Historique</button>
    </nav>

    <div class="page-wrapper" id="pageWrapper">
        <!-- PAGE 1 : Tableau Obeya -->
        <div class="page page-tableau">
        <div class="main-content">
            <div class="app-header">
                <img src="icons/logo-areas.svg" alt="Areas Assurances" style="height: 70px; margin-bottom: 8px;">
                <h1>Tableau Obeya</h1>
                <div class="subtitle">Suivi temporel des dossiers - Vue flux</div>
                <div class="header-actions no-print">
                    <button class="header-btn" onclick="imprimer()" title="Imprimer">üñ®Ô∏è</button>
                    <button class="header-btn" onclick="showHelp()" title="Aide">‚ùì</button>
                </div>
            </div>
            
            <div class="voice-help-box no-print">
                <div class="voice-help-title">üéôÔ∏è Commandes vocales disponibles :</div>
                <div class="voice-help-item">"Cr√©e une fiche au nom de Dupont pour un contrat auto pro"</div>
                <div class="voice-help-item">"Nouveau client Martin sant√© particulier"</div>
                <div class="voice-help-item">"Rajoute une note √† la fiche de Dupont pour lui dire de me rappeler"</div>
                <div class="voice-help-item">"Le devis de Dupont a √©t√© envoy√©" / "Forestier est sign√©"</div>
                <div class="voice-help-item">"Mets Dupont en devis en cours" / "D√©place Dupont vers sign√©s"</div>
            </div>

            <div class="synthese-box">
                <div class="synthese-title">üìà Synth√®se Hebdomadaire (en cours)</div>
                <div class="synthese-content">
                    <div class="synthese-date">
                        Semaine <input type="text" id="num-semaine" readonly> du <input type="text" id="date-debut" class="date-full" readonly> au <input type="text" id="date-fin" class="date-full" readonly>
                    </div>
                    <div class="synthese-item">
                        Demand√©s : <input type="number" id="synth-demandes" class="historique" readonly value="0">
                    </div>
                    <div class="synthese-item">
                        Envoy√©s : <input type="number" id="synth-envoyes" class="auto-calc" readonly value="0">
                    </div>
                    <div class="synthese-item">
                        Sign√©s : <input type="number" id="synth-signes" class="auto-calc" readonly value="0">
                    </div>
                    <div class="synthese-item synthese-euro">
                        ‚Ç¨ <input type="number" id="synth-euros" value="0" style="width: 80px; font-size: 18px; color: #27ae60;">
                    </div>
                </div>
            </div>

            <div class="time-legend">
                Temps qui passe <span class="arrow">‚Üí</span>
            </div>

            <table class="main-table">
                <thead class="table-header">
                    <tr>
                        <th>STATUT</th>
                        <th>Semaine N<br><small>(Nouveaux)</small></th>
                        <th>Semaine N+1<br><small>(Retards)</small></th>
                        <th>Semaine N+2<br><small>(Urgents)</small></th>
                        <th>üö® PARKING<br><small>(Critique)</small></th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="status-row-demandes">
                        <td class="col-status">
                            <span class="status-icon">üü°</span>
                            DEMANDES
                            <span class="status-text">Nouvelles demandes de devis</span>
                        </td>
                        <td class="col-week drop-zone" data-week="N" data-status="demandes">
                            <button class="add-slot-btn no-print" onclick="ouvrirModal('demandes', 'N')">+ Ajouter</button>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+1" data-status="demandes">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+2" data-status="demandes">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone col-parking" data-week="parking" data-status="demandes">
                            <div class="parking-header">‚ö†Ô∏è √Ä relancer urgent</div>
                            <div class="no-add">Glissez ici</div>
                        </td>
                    </tr>
                    
                    <tr class="status-row-devis">
                        <td class="col-status">
                            <span class="status-icon">üîµ</span>
                            DEVIS EN COURS
                            <span class="status-text">√âtude et pr√©paration en cours</span>
                        </td>
                        <td class="col-week drop-zone" data-week="N" data-status="devis">
                            <button class="add-slot-btn no-print" onclick="ouvrirModal('devis', 'N')">+ Ajouter</button>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+1" data-status="devis">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+2" data-status="devis">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone col-parking" data-week="parking" data-status="devis">
                            <div class="parking-header">‚ö†Ô∏è Bloqu√© / √Ä voir</div>
                            <div class="no-add">Glissez ici</div>
                        </td>
                    </tr>
                    
                    <tr class="status-row-envoyes">
                        <td class="col-status">
                            <span class="status-icon">üü£</span>
                            DEVIS ENVOY√âS
                            <span class="status-text">Attente retour client</span>
                        </td>
                        <td class="col-week drop-zone" data-week="N" data-status="envoyes">
                            <button class="add-slot-btn no-print" onclick="ouvrirModal('envoyes', 'N')">+ Ajouter</button>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+1" data-status="envoyes">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+2" data-status="envoyes">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone col-parking" data-week="parking" data-status="envoyes">
                            <div class="parking-header">‚ö†Ô∏è Sans r√©ponse</div>
                            <div class="no-add">Glissez ici</div>
                        </td>
                    </tr>
                    
                    <tr class="status-row-signes">
                        <td class="col-status">
                            <span class="status-icon">üü¢</span>
                            DEVIS SIGN√âS
                            <span class="status-text">Contrats finalis√©s</span>
                        </td>
                        <td class="col-week drop-zone" data-week="N" data-status="signes">
                            <button class="add-slot-btn no-print" onclick="ouvrirModal('signes', 'N')">+ Ajouter</button>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+1" data-status="signes">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone read-only" data-week="N+2" data-status="signes">
                            <div class="no-add">‚Äî</div>
                        </td>
                        <td class="col-week drop-zone col-parking" data-week="parking" data-status="signes">
                            <div class="parking-header">‚úÖ Archiver</div>
                            <div class="no-add">Glissez ici</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="stickers-bar no-print">
                <div class="stickers-title">üè∑Ô∏è L√©gende des actions :</div>
                <div class="stickers-list">
                    <div class="sticker-legend-item">
                        <div class="sticker-dot" style="background: #e74c3c;"></div>
                        <span><strong>Relancer</strong></span>
                    </div>
                    <div class="sticker-legend-item">
                        <div class="sticker-dot" style="background: #f39c12;"></div>
                        <span><strong>Rappeler</strong></span>
                    </div>
                    <div class="sticker-legend-item">
                        <div class="sticker-dot" style="background: #f1c40f;"></div>
                        <span><strong>Voir compagnie</strong></span>
                    </div>
                    <div class="sticker-legend-item">
                        <div class="sticker-dot" style="background: #3498db;"></div>
                        <span><strong>Devis envoy√©</strong></span>
                    </div>
                    <div class="sticker-legend-item">
                        <div class="sticker-dot" style="background: #2c3e50;"></div>
                        <span><strong>Sign√©</strong></span>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- fin .page-tableau -->

        <!-- PAGE 2 : Historique & Stats -->
        <div class="page page-historique">
        <div class="historique-panel">
            <div class="historique-title">
                üìö Historique
                <span style="font-size: 11px; color: #7f8c8d; font-weight: normal;">(par semaine)</span>
            </div>
            
            <div id="historique-container">
                <div style="text-align: center; color: #95a5a6; padding: 20px; font-size: 12px;">Aucune semaine cl√¥tur√©e</div>
            </div>
            
            <div class="stats-duree-section">
                <div class="stats-duree-title">‚è±Ô∏è Stats Dur√©e Devis ‚Üí Signature</div>
                <div class="stats-duree-box">
                    <div class="stats-duree-header">üìä Temps de conversion</div>
                    <div class="stats-duree-grid">
                        <div class="stats-duree-item">
                            <span class="stats-duree-value" id="duree-min">-</span>
                            <span class="stats-duree-label">Plus court</span>
                        </div>
                        <div class="stats-duree-item">
                            <span class="stats-duree-value" id="duree-max">-</span>
                            <span class="stats-duree-label">Plus long</span>
                        </div>
                    </div>
                    <div class="stats-duree-moyenne">
                        <span class="stats-duree-moyenne-value" id="duree-moyenne">-</span>
                        <span class="stats-duree-moyenne-label">jours en moyenne</span>
                    </div>
                </div>
                <div class="stats-duree-detail">
                    <div class="stats-duree-detail-item">
                        <span class="stats-duree-detail-label">Dossiers sign√©s :</span>
                        <span class="stats-duree-detail-value" id="nb-dossiers-signes">0</span>
                    </div>
                    <div class="stats-duree-detail-item">
                        <span class="stats-duree-detail-label">M√©diane :</span>
                        <span class="stats-duree-detail-value" id="duree-mediane">-</span>
                    </div>
                </div>
            </div>
            
            <button class="btn-cloturer" onclick="cloturerSemaine()">‚úÖ Cl√¥turer la semaine</button>
        </div>
        </div><!-- fin .page-historique -->
    </div><!-- fin .page-wrapper -->

    <!-- Bouton Micro -->
    <div class="mic-container no-print">
        <div class="mic-hint" id="micHint">Appuyez pour parler</div>
        <button class="mic-button" id="micBtn" onclick="toggleVoice()">üé§</button>
    </div>

    <!-- Modal Voice -->
    <div class="voice-modal no-print" id="voiceModal">
        <button class="voice-close" onclick="stopVoice()">‚úï</button>
        <div class="voice-visualizer">
            <div class="voice-waves"></div>
            üé§
        </div>
        <div class="voice-text" id="voiceText">Appuyez sur le micro et parlez...</div>
        <div class="voice-commands">
            <div class="voice-commands-title">Commandes disponibles</div>
            <div class="voice-command-item">üéôÔ∏è "Cr√©e une fiche au nom de [Nom] pour un contrat [Type] [Pro/Part]"</div>
            <div class="voice-command-item">üéôÔ∏è "Nouveau client [Nom] [Type] [Pro/Part]"</div>
            <div class="voice-command-item">üìù "Rajoute une note √† la fiche de [Nom] pour [texte]"</div>
            <div class="voice-command-item">‚û°Ô∏è "Le devis de [Nom] a √©t√© envoy√©/sign√©"</div>
            <div class="voice-command-item">‚û°Ô∏è "Mets [Nom] en devis en cours / envoy√©s / sign√©s"</div>
        </div>
    </div>

    <!-- Modal √âdition -->
    <div class="modal no-print" id="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">üìù Nouvelle fiche</div>
            <form id="fiche-form" onsubmit="saveForm(event)">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>Nom client</label>
                    <input type="text" id="client-name" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="client-type">
                        <option value="Auto">üöó Auto</option>
                        <option value="Sant√©">üè• Sant√©</option>
                        <option value="GAV">üõ°Ô∏è GAV</option>
                        <option value="MRH">üè° MRH</option>
                        <option value="DAB">üè† DAB</option>
                        <option value="Collective">üë• Collective</option>
                        <option value="Multi">üìã Multi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cat√©gorie</label>
                    <select id="client-cat">
                        <option value="PART">üë§ Particulier</option>
                        <option value="PRO">üè¢ Professionnel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="client-notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Stickers</label>
                    <div class="sticker-selector" id="stickerSelector">
                        <div class="sticker-option" style="background: #e74c3c;" data-color="red" onclick="toggleSticker(this)"></div>
                        <div class="sticker-option" style="background: #f39c12;" data-color="orange" onclick="toggleSticker(this)"></div>
                        <div class="sticker-option" style="background: #f1c40f;" data-color="yellow" onclick="toggleSticker(this)"></div>
                        <div class="sticker-option" style="background: #3498db;" data-color="blue" onclick="toggleSticker(this)"></div>
                        <div class="sticker-option" style="background: #2c3e50;" data-color="black" onclick="toggleSticker(this)"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-delete" id="btnDelete" onclick="supprimerFiche()" style="display:none;">üóëÔ∏è</button>
                    <button type="button" class="btn btn-cancel" onclick="fermerModal()">Annuler</button>
                    <button type="submit" class="btn btn-save">üíæ Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let currentStatus = '', currentWeek = '', editingCard = null, selectedStickers = [], draggedCard = null;
        let currentWeekData = { numero: 0, debut: '', fin: '', demandes: 0, envoyes: 0, signes: 0, euros: 0 };
        let historiqueSemaines = [], clients = [], recognition = null, isListening = false;
        let deferredPrompt = null;
        let currentPage = 0; // 0 = Tableau, 1 = Historique

        const stickerColors = { red: '#e74c3c', orange: '#f39c12', yellow: '#f1c40f', blue: '#3498db', black: '#2c3e50' };

        // Firebase - Synchronisation temps r√©el
        const firebaseConfig = {
            apiKey: "AIzaSyB8PdInd3QLtE3Ft-A3A6SB42QVpYO_-eQ",
            authDomain: "obeya-suivi.firebaseapp.com",
            projectId: "obeya-suivi",
            storageBucket: "obeya-suivi.firebasestorage.app",
            messagingSenderId: "781403536135",
            appId: "1:781403536135:web:d186cfa46ea3f163b9a3a2"
        };
        let firebaseDb = null, firebaseModules = null;
        let isLoadingFromFirebase = false, saveTimeout = null, lastSavedVersion = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            initDates();
            initDragAndDrop();
            initTouchEvents();
            initSpeechRecognition();
            initPWA();
            initPageSwipe();
            chargerDonnees();
            calculerSynthese();
            afficherHistorique();
            calculerStatsDuree();
            scannerClientsExistants();
            // Charger les fiches sauvegard√©es localement (en attendant Firebase)
            chargerFichesLocales();
            // V√©rifier si la semaine active est d√©pass√©e (auto-cl√¥ture)
            verifierClotureSemaine();
            // Sauvegarder vers Firebase quand on modifie les euros
            document.getElementById('synth-euros').addEventListener('change', () => sauvegarderVersFirebase());
            document.getElementById('synth-euros').addEventListener('input', () => sauvegarderVersFirebase());
            // Initialiser Firebase (async, ne bloque pas le chargement)
            initFirebase();
        });

        // PWA - Installation
        function initPWA() {
            // Gestion du beforeinstallprompt pour Chrome/Android
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // Afficher le bouton d'installation apr√®s 3 secondes
                setTimeout(() => {
                    if (!window.matchMedia('(display-mode: standalone)').matches) {
                        document.getElementById('installPrompt').classList.add('show');
                    }
                }, 3000);
            });

            // D√©tection si d√©j√† install√©
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                console.log('App d√©j√† install√©e');
            }

            // Service Worker pour offline et installation PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(function() {});
            }
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('‚úÖ Application install√©e !');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('show');
                });
            } else {
                // Fallback pour iOS
                showToast('üì± Sur iOS : Partager ‚Üí "Sur l\'√©cran d\'accueil"');
            }
        }

        function dismissInstall() {
            document.getElementById('installPrompt').classList.remove('show');
        }

        // === Navigation entre pages (swipe + boutons) ===
        function naviguerVers(page) {
            currentPage = page;
            const wrapper = document.getElementById('pageWrapper');
            if (page === 1) {
                wrapper.classList.add('on-historique');
            } else {
                wrapper.classList.remove('on-historique');
            }
            // Mettre √† jour les boutons et dots
            document.getElementById('navTableau').classList.toggle('active', page === 0);
            document.getElementById('navHistorique').classList.toggle('active', page === 1);
            document.getElementById('dot0').classList.toggle('active', page === 0);
            document.getElementById('dot1').classList.toggle('active', page === 1);
            // Scroll en haut de la nouvelle page
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function initPageSwipe() {
            const wrapper = document.getElementById('pageWrapper');
            let startX = 0, startY = 0, isDragging = false;
            const SWIPE_THRESHOLD = 60;

            wrapper.addEventListener('touchstart', (e) => {
                // Ignorer si on est dans une zone de drag des fiches
                if (e.target.closest('.client-slot') || e.target.closest('.drop-zone')) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = true;
            }, { passive: true });

            wrapper.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const diffX = startX - endX;
                const diffY = Math.abs(startY - endY);

                // Swipe horizontal seulement si le mouvement est plus horizontal que vertical
                if (Math.abs(diffX) > SWIPE_THRESHOLD && Math.abs(diffX) > diffY) {
                    if (diffX > 0 && currentPage === 0) {
                        // Swipe gauche ‚Üí page historique
                        naviguerVers(1);
                    } else if (diffX < 0 && currentPage === 1) {
                        // Swipe droite ‚Üí page tableau
                        naviguerVers(0);
                    }
                }
            }, { passive: true });
        }

        function initDates() {
            const today = new Date();
            const currentDay = today.getDay();
            const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
            const lundi = new Date(today.setDate(diff));
            const dimanche = new Date(today.setDate(lundi.getDate() + 6));
            const debutAnnee = new Date(lundi.getFullYear(), 0, 1);
            const jours = Math.floor((lundi - debutAnnee) / (24 * 60 * 60 * 1000));
            const numeroSemaine = Math.ceil(jours / 7);
            const formatDate = (d) => d.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: '2-digit'});
            
            currentWeekData = { ...currentWeekData, numero: numeroSemaine, debut: formatDate(lundi), fin: formatDate(dimanche) };
            document.getElementById('num-semaine').value = numeroSemaine;
            document.getElementById('date-debut').value = currentWeekData.debut;
            document.getElementById('date-fin').value = currentWeekData.fin;
        }

        // Speech Recognition - VERSION CORRIG√âE
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                showToast('‚ö†Ô∏è Reconnaissance vocale non support√©e');
                document.getElementById('micBtn').style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('micBtn').classList.add('listening');
                document.getElementById('voiceModal').classList.add('active');
                document.getElementById('voiceText').textContent = '√âcoute en cours... Parlez maintenant';
                console.log('Reconnaissance d√©marr√©e');
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (interimTranscript) {
                    document.getElementById('voiceText').textContent = interimTranscript;
                }

                if (finalTranscript) {
                    console.log('Transcription finale:', finalTranscript);
                    document.getElementById('voiceText').textContent = finalTranscript;
                    processVoiceCommand(finalTranscript);
                }
            };

            recognition.onerror = (event) => {
                console.error('Erreur reconnaissance:', event.error);
                let msg = 'Erreur de reconnaissance';
                
                switch(event.error) {
                    case 'not-allowed':
                        msg = '‚ö†Ô∏è Autorisez le micro dans les param√®tres';
                        break;
                    case 'no-speech':
                        msg = 'Aucune parole d√©tect√©e. R√©essayez.';
                        break;
                    case 'network':
                        msg = 'Probl√®me r√©seau. V√©rifiez votre connexion.';
                        break;
                    case 'aborted':
                        msg = 'Reconnaissance annul√©e';
                        break;
                    default:
                        msg = 'Erreur: ' + event.error;
                }
                
                showToast(msg);
                
                // Ne pas arr√™ter compl√®tement sur erreur non fatale
                if (event.error !== 'not-allowed' && event.error !== 'service-not-allowed') {
                    setTimeout(() => {
                        if (isListening) {
                            try { recognition.start(); } catch(e) {}
                        }
                    }, 1000);
                } else {
                    stopVoice();
                }
            };

            recognition.onend = () => {
                console.log('Reconnaissance termin√©e');
                // Red√©marrer automatiquement si on est toujours en mode √©coute
                if (isListening) {
                    try {
                        recognition.start();
                    } catch(e) {
                        stopVoice();
                    }
                }
            };
        }

        async function toggleVoice() {
            if (!recognition) {
                showToast('Reconnaissance vocale non disponible');
                return;
            }

            if (isListening) {
                stopVoice();
            } else {
                try {
                    // Demander explicitement la permission sur mobile
                    if (navigator.permissions && navigator.permissions.query) {
                        const result = await navigator.permissions.query({ name: 'microphone' });
                        if (result.state === 'denied') {
                            showToast('‚ö†Ô∏è Autorisez le micro dans les param√®tres de votre navigateur');
                            return;
                        }
                    }
                    
                    // Sur iOS, il faut parfois un user gesture explicite
                    recognition.start();
                } catch (err) {
                    console.error('Erreur d√©marrage:', err);
                    showToast('Erreur d√©marrage micro. R√©essayez.');
                    
                    // Fallback : recr√©er l'instance
                    initSpeechRecognition();
                    setTimeout(() => {
                        try { recognition.start(); } catch(e) {}
                    }, 500);
                }
            }
        }

        function stopVoice() {
            isListening = false;
            document.getElementById('micBtn').classList.remove('listening');
            document.getElementById('voiceModal').classList.remove('active');
            if (recognition) {
                try { recognition.stop(); } catch(e) {}
            }
        }

        // Traitement commandes vocales
        function detectTypeContrat(str) {
            if (!str) return null;
            const s = str.toLowerCase();
            if (s.includes('sant') || s.includes('mutuel')) return 'Sant√©';
            if (s.includes('gav')) return 'GAV';
            if (s.includes('mrh') || s.includes('habitation')) return 'MRH';
            if (s.includes('dab')) return 'DAB';
            if (s.includes('collect')) return 'Collective';
            if (s.includes('multi')) return 'Multi';
            if (s.includes('auto') || s.includes('voiture')) return 'Auto';
            return null;
        }

        function detectCategorie(str) {
            if (!str) return null;
            const s = str.toLowerCase();
            if (s.includes('pro') || s.includes('entreprise')) return 'PRO';
            if (s.includes('part')) return 'PART';
            return null;
        }

        // Nettoyer un nom : enlever titres, articles, mots-cl√©s contrat/cat√©gorie
        function nettoyerNom(raw) {
            let nom = raw.trim();
            // Retirer les titres de civilit√©
            nom = nom.replace(/^(?:monsieur|madame|mademoiselle|mme|mr?|mlle)\s+/i, '');
            // Retirer les mots-cl√©s contrat/cat√©gorie en fin
            nom = nom.replace(/\s+(?:auto|automobile|voiture|sant√©|sante|mutuelle|gav|mrh|habitation|dab|collective|multi|particulier|part|pro|professionnel|professionnelle|entreprise)\s*$/gi, '');
            // Retirer mots r√©siduels
            nom = nom.replace(/\s+(?:pour|un|une|le|la|les|de|du|des|contrat)\s*$/gi, '');
            // Capitaliser chaque mot
            nom = nom.trim().split(/\s+/).filter(w => w.length > 0).map(w => capitalize(w)).join(' ');
            return nom;
        }

        // Trouver type + cat√©gorie dans une cha√Æne de mots
        function extraireTypeEtCat(str) {
            let type = null, cat = null;
            if (!str) return { type, cat };
            const mots = str.trim().split(/\s+/);
            for (const mot of mots) {
                if (!type) type = detectTypeContrat(mot);
                if (!cat) cat = detectCategorie(mot);
            }
            return { type, cat };
        }

        function processVoiceCommand(text) {
            let lowerText = text.toLowerCase().trim()
                .replace(/['']/g, "'")
                .replace(/\s+/g, ' ');
            console.log('Commande brute:', lowerText);

            // Corrections des erreurs fr√©quentes de reconnaissance vocale
            const corrections = [
                // "d√©place" mal reconnu
                [/\bdes?\s*places?\b/g, 'd√©place'],
                [/\bd√© place\b/g, 'd√©place'],
                [/\bdes\s*plac√©\b/g, 'd√©place'],
                [/\bdes\s*plac[e√©]s?\b/g, 'd√©place'],
                // "mets/met" mal reconnu
                [/\bmais\b(?=\s+\w+\s+(?:en|vers|dans|au))/g, 'mets'],
                [/\bmai\b(?=\s+\w+\s+(?:en|vers|dans|au))/g, 'mets'],
                [/\bmes\b(?=\s+\w+\s+(?:en|vers|dans|au))/g, 'mets'],
                [/\bmet\b(?=\s+\w+\s+(?:en|vers|dans|au))/g, 'mets'],
                // "passe" mal reconnu
                [/\bpas\b(?=\s+\w+\s+(?:en|vers|dans|au))/g, 'passe'],
                // statuts mal reconnus
                [/\bsigner\b/g, 'sign√©s'],
                [/\bsign√©\b/g, 'sign√©s'],
                [/\bsign√©e?\b/g, 'sign√©s'],
                [/\bsin ?y√©\b/g, 'sign√©s'],
                [/\benvoyer\b/g, 'envoy√©s'],
                [/\benvoy√©\b/g, 'envoy√©s'],
                [/\benvoy√©e?\b/g, 'envoy√©s'],
                [/\ban ?voy√©\b/g, 'envoy√©s'],
                [/\bdemand√©e?\b/g, 'demandes'],
                [/\bdemander\b/g, 'demandes'],
                // "cr√©e" mal reconnu
                [/\bcr√©\b/g, 'cr√©e'],
                [/\bcrais?\b/g, 'cr√©e'],
                [/\bgr√©e?\b/g, 'cr√©e'],
                // "fiche" mal reconnu
                [/\bfish\b/g, 'fiche'],
                [/\bfiche?\b/g, 'fiche'],
                // "ajoute" mal reconnu
                [/\ba joute\b/g, 'ajoute'],
                [/\bajout\b/g, 'ajoute'],
                // "note" / "dossier" mal reconnus
                [/\bnotte?\b/g, 'note'],
                [/\bdauci[e√©]\b/g, 'dossier'],
                [/\bdos ?sier\b/g, 'dossier'],
                // "vers" mal reconnu
                [/\bverre?s?\b/g, 'vers'],
                [/\bvert?s?\b/g, 'vers'],
                // "devis" mal reconnu
                [/\bde vie?\b/g, 'devis'],
                [/\bdevi\b/g, 'devis'],
                // "a √©t√©" mal reconnu
                [/\ba √©tai[ts]?\b/g, 'a √©t√©'],
                [/\ba√©t√©\b/g, 'a √©t√©'],
                // "en cours" mal reconnu
                [/\bancour[s]?\b/g, 'en cours'],
                [/\ben cour\b/g, 'en cours'],
                // "trait√©" mal reconnu
                [/\btrait[e√©]e?\b/g, 'trait√©'],
            ];

            for (const [pattern, replacement] of corrections) {
                lowerText = lowerText.replace(pattern, replacement);
            }
            console.log('Commande corrig√©e:', lowerText);

            let m;

            // ============================
            // === CREATION DE FICHE ===
            // ============================

            // Pattern A: "cr√©e/ajoute une fiche/un client au nom de [Monsieur] <Nom> pour un contrat <type> [<cat>]"
            m = lowerText.match(/(?:cr√©er?|cr√©e[sz]?|ajoute[rzs]?|rajoute[rzs]?|nouveau|nouvelle)\s+.*?au\s+nom\s+de\s+(.+?)\s+pour\s+(?:un\s+)?(?:contrat\s+)?(?:d[e']\s*)?(.+)$/i);
            if (m) {
                const nom = nettoyerNom(m[1]);
                const reste = m[2];
                const { type, cat } = extraireTypeEtCat(reste);
                if (nom) {
                    stopVoice();
                    setTimeout(() => createClientFromVoice(nom, type || 'Auto', cat || 'PART'), 300);
                    return;
                }
            }

            // Pattern B: "cr√©e/ajoute une fiche/un client au nom de [Monsieur] <Nom> [<type>] [<cat>]"
            m = lowerText.match(/(?:cr√©er?|cr√©e[sz]?|ajoute[rzs]?|rajoute[rzs]?|nouveau|nouvelle)\s+.*?au\s+nom\s+de\s+(.+)$/i);
            if (m) {
                const raw = m[1];
                const { type, cat } = extraireTypeEtCat(raw);
                const nom = nettoyerNom(raw);
                if (nom) {
                    stopVoice();
                    setTimeout(() => createClientFromVoice(nom, type || 'Auto', cat || 'PART'), 300);
                    return;
                }
            }

            // Pattern C: "cr√©e/ajoute une fiche/un client [pour] [Monsieur] <Nom> [<type>] [<cat>]"
            m = lowerText.match(/(?:cr√©er?|cr√©e[sz]?|ajoute[rzs]?|rajoute[rzs]?|nouveau|nouvelle)\s+(?:une?\s+)?(?:client[e]?|fiche|dossier)\s+(?:pour\s+)?(.+)$/i);
            if (m) {
                const raw = m[1];
                const { type, cat } = extraireTypeEtCat(raw);
                const nom = nettoyerNom(raw);
                if (nom) {
                    stopVoice();
                    setTimeout(() => createClientFromVoice(nom, type || 'Auto', cat || 'PART'), 300);
                    return;
                }
            }

            // Pattern D: original compact - "nouveau client <Nom> [<type>] [<cat>]"
            m = lowerText.match(/(?:nouveau|nouvelle)\s+(?:client[e]?)?\s*(.+)$/i);
            if (m) {
                const raw = m[1];
                const { type, cat } = extraireTypeEtCat(raw);
                const nom = nettoyerNom(raw);
                if (nom) {
                    stopVoice();
                    setTimeout(() => createClientFromVoice(nom, type || 'Auto', cat || 'PART'), 300);
                    return;
                }
            }

            // ============================
            // === AJOUT DE NOTE ===
            // ============================

            // Pattern A: "rajoute/ajoute une note au dossier/√† la fiche de [Monsieur] <Nom> pour lui dire de <texte>"
            m = lowerText.match(/(?:r?ajoute[rzs]?|note[rzs]?|met[st]?r?e?)\s+(?:une\s+)?note\s+(?:au\s+dossier|[√†a]\s+la\s+fiche|sur\s+(?:la\s+)?fiche|sur\s+(?:le\s+)?dossier)\s+(?:de\s+|du\s+)(?:(?:monsieur|madame|mme|mr?)\s+)?(.+?)\s+pour\s+(?:lui\s+)?(?:dire\s+)?(?:de\s+|d['e]\s*)?(.+)$/i);
            if (m) {
                const nom = capitalize(m[1].trim().split(/\s+/)[0]);
                const note = m[2].trim();
                stopVoice();
                addNoteToClient(nom, note);
                return;
            }

            // Pattern B: "rajoute/ajoute une note au dossier/√† la fiche de <Nom> : <texte>"
            m = lowerText.match(/(?:r?ajoute[rzs]?|note[rzs]?|met[st]?r?e?)\s+(?:une\s+)?note\s+(?:au\s+dossier|[√†a]\s+la\s+fiche|sur\s+(?:la\s+)?fiche|sur\s+(?:le\s+)?dossier)\s+(?:de\s+|du\s+)(?:(?:monsieur|madame|mme|mr?)\s+)?(.+?)[\s:,]+(.+)$/i);
            if (m) {
                const nom = capitalize(m[1].trim().split(/\s+/)[0]);
                const note = m[2].trim();
                if (note.length > 1) {
                    stopVoice();
                    addNoteToClient(nom, note);
                    return;
                }
            }

            // Pattern C: "ajoute/rajoute une note √†/pour <Nom> pour lui dire de <texte>"
            m = lowerText.match(/(?:r?ajoute[rzs]?|note[rzs]?|met[st]?r?e?)\s+(?:une\s+)?note\s+(?:[√†a]|pour|sur)\s+(?:(?:monsieur|madame|mme|mr?)\s+)?(.+?)\s+pour\s+(?:lui\s+)?(?:dire\s+)?(?:de\s+|d['e]\s*)?(.+)$/i);
            if (m) {
                const nom = capitalize(m[1].trim().split(/\s+/)[0]);
                const note = m[2].trim();
                stopVoice();
                addNoteToClient(nom, note);
                return;
            }

            // Pattern D: "ajoute/note √†/pour/sur <Nom> : <texte>" (compact)
            m = lowerText.match(/(?:r?ajoute[rzs]?|note[rzs]?)\s+(?:une\s+)?(?:note\s+)?(?:[√†a]|pour|sur)\s+(?:(?:monsieur|madame|mme|mr?)\s+)?(\w+)[\s:,]+(.+)$/i);
            if (m) {
                const nom = capitalize(m[1].trim());
                const note = m[2].trim();
                stopVoice();
                addNoteToClient(nom, note);
                return;
            }

            // ============================
            // === DEPLACEMENT ===
            // ============================

            // Helper r√©solution statut
            function resolveStatus(str) {
                const s = str.toLowerCase();
                if (s.includes('demand')) return 'demandes';
                if (s.includes('cours') || s.includes('trait')) return 'devis';
                if (s.includes('envoy')) return 'envoyes';
                if (s.includes('sign')) return 'signes';
                if (s.includes('park')) return 'parking';
                return null;
            }

            // Pattern A: "d√©place/mets/passe <Nom> en/vers/dans <statut>"
            m = lowerText.match(/(?:d√©place[rzs]?|deplace[rzs]?|met[st]?r?e?|passe[rzs]?|bouge[rzs]?|move)\s+(?:(?:la\s+fiche|le\s+dossier|le\s+client|le\s+devis)\s+(?:de\s+)?)?(?:(?:monsieur|madame|mme|mr?)\s+)?(\w+)\s+(?:vers|dans|en|au|aux?)\s*(demandes?|demander?|(?:devis\s+)?en\s*cours|envoy[e√©√®]\w*|sign[e√©√®]\w*|parking|trait[e√©√®]\w*)/i);
            if (m) {
                const nom = capitalize(m[1]);
                const status = resolveStatus(m[2]);
                if (status) {
                    stopVoice();
                    moveClientByName(nom, status);
                    return;
                }
            }

            // Pattern B: "le devis/la fiche de [Mr] <Nom> a √©t√©/est envoy√©/sign√©/en cours"
            m = lowerText.match(/(?:le\s+devis|la\s+fiche|le\s+dossier|le\s+client)\s+(?:de\s+|du\s+)(?:(?:monsieur|madame|mme|mr?)\s+)?(\w+)\s+(?:a\s+√©t√©|est)\s+(envoy[e√©√®]\w*|sign[e√©√®]\w*|(?:devis\s+)?en\s*cours|demand[e√©√®]\w*|trait[e√©√®]\w*|parking)/i);
            if (m) {
                const nom = capitalize(m[1]);
                const status = resolveStatus(m[2]);
                if (status) {
                    stopVoice();
                    moveClientByName(nom, status);
                    return;
                }
            }

            // Pattern C: "<Nom> a √©t√©/est envoy√©/sign√©/en cours" (ultra-compact)
            m = lowerText.match(/^(?:(?:monsieur|madame|mme|mr?)\s+)?(\w+)\s+(?:a\s+√©t√©|est)\s+(envoy[e√©√®]\w*|sign[e√©√®]\w*|(?:devis\s+)?en\s*cours|demand[e√©√®]\w*|trait[e√©√®]\w*)/i);
            if (m) {
                const nom = capitalize(m[1]);
                const status = resolveStatus(m[2]);
                if (status) {
                    stopVoice();
                    moveClientByName(nom, status);
                    return;
                }
            }

            showToast('‚ùì Commande non reconnue. Essayez : "Cr√©e une fiche au nom de Dupont pour un contrat auto"');
            setTimeout(stopVoice, 2000);
        }

        function createClientFromVoice(nom, type, cat) {
            const card = document.createElement('div');
            card.className = 'client-slot new';
            card.draggable = true;
            const today = new Date().toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'});
            
            card.innerHTML = `
                <div class="slot-header">
                    <span class="slot-name">${nom}</span>
                    <span class="slot-edit no-print">‚úèÔ∏è</span>
                </div>
                <div class="slot-type">${cat} - ${type}</div>
                <div class="slot-dates" data-demande="${today}">
                    <div class="slot-date-item"><span class="slot-date-label">üü° Demand√©:</span> ${today}</div>
                </div>
                <div class="slot-stickers"></div>
            `;
            
            makeDraggable(card);
            card.querySelector('.slot-edit').addEventListener('click', (e) => {
                e.stopPropagation();
                editerFiche(card);
            });
            
            const cell = document.querySelector('td[data-week="N"][data-status="demandes"]');
            const btn = cell.querySelector('.add-slot-btn');
            cell.insertBefore(card, btn);
            
            clients.push({nom: nom, element: card});
            calculerSynthese();
            calculerStatsDuree();
            showToast(`‚úÖ Client ${nom} cr√©√©`);
            card.scrollIntoView({behavior: 'smooth', block: 'center'});
        }

        // Recherche souple d'un client par nom (partiel, insensible √† la casse)
        function findClientCards(nom) {
            const allCards = document.querySelectorAll('.client-slot');
            const search = nom.toLowerCase().trim();
            const results = [];
            allCards.forEach(card => {
                const nameEl = card.querySelector('.slot-name');
                if (!nameEl) return;
                const cardName = nameEl.textContent.toLowerCase().trim();
                // Match exact, ou le nom de la carte contient le terme recherch√©, ou inversement
                if (cardName === search || cardName.includes(search) || search.includes(cardName) || cardName.startsWith(search) || cardName.split(' ').some(w => w === search)) {
                    results.push(card);
                }
            });
            return results;
        }

        function addNoteToClient(nom, note) {
            const matchingCards = findClientCards(nom);
            let found = false;

            matchingCards.forEach(card => {
                let notesEl = card.querySelector('.slot-notes');
                if (!notesEl) {
                    notesEl = document.createElement('div');
                    notesEl.className = 'slot-notes';
                    const datesDiv = card.querySelector('.slot-dates');
                    card.insertBefore(notesEl, datesDiv ? datesDiv.nextSibling : null);
                }

                const timestamp = new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                const existing = notesEl.textContent;
                notesEl.textContent = existing ? `${existing} | ${timestamp}: ${note}` : `${timestamp}: ${note}`;

                found = true;
                card.style.background = '#fff3cd';
                setTimeout(() => card.style.background = '', 1000);
            });
            
            showToast(found ? `üìù Note ajout√©e √† ${nom}` : `‚ùå Client ${nom} non trouv√©`);
            if (found) sauvegarderVersFirebase();
        }

        function moveClientByName(nom, newStatus) {
            const matchingCards = findClientCards(nom);
            let found = false;

            matchingCards.forEach(card => {
                const targetCell = document.querySelector(`td[data-week="N"][data-status="${newStatus}"]`);
                if (targetCell) {
                    const btn = targetCell.querySelector('.add-slot-btn') || targetCell.querySelector('.no-add');
                    targetCell.insertBefore(card, btn);
                    mettreAJourDate(card, newStatus);
                    found = true;
                }
            });
            
            if (found) {
                calculerSynthese();
                calculerStatsDuree();
                showToast(`‚úÖ ${nom} d√©plac√©`);
            } else {
                showToast(`‚ùå Client ${nom} non trouv√©`);
            }
        }

        // Drag & Drop + Touch
        function initDragAndDrop() {
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', handleDrop);
            });

            document.addEventListener('dragover', (e) => {
                const deleteZone = document.getElementById('deleteZone');
                if (draggedCard && e.clientY > window.innerHeight - 150) {
                    deleteZone.classList.add('active');
                } else {
                    deleteZone.classList.remove('active');
                }
            });

            document.addEventListener('drop', (e) => {
                if (draggedCard && e.clientY > window.innerHeight - 150) {
                    draggedCard.remove();
                    document.getElementById('deleteZone').classList.remove('active');
                    draggedCard = null;
                    calculerSynthese();
                    calculerStatsDuree();
                }
            });
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedCard) {
                const btn = this.querySelector('.add-slot-btn') || this.querySelector('.no-add');
                this.insertBefore(draggedCard, btn);
                draggedCard.classList.remove('dragging');
                mettreAJourDate(draggedCard, this.dataset.status);
                draggedCard = null;
                calculerSynthese();
                calculerStatsDuree();
            }
        }

        function initTouchEvents() {
            let touchItem = null, touchOffset = {x: 0, y: 0}, originalParent = null;
            
            document.addEventListener('touchstart', (e) => {
                if (e.target.closest('.client-slot')) {
                    touchItem = e.target.closest('.client-slot');
                    const touch = e.touches[0];
                    const rect = touchItem.getBoundingClientRect();
                    touchOffset.x = touch.clientX - rect.left;
                    touchOffset.y = touch.clientY - rect.top;
                    originalParent = touchItem.parentNode;
                    
                    touchItem.style.position = 'fixed';
                    touchItem.style.zIndex = '1000';
                    touchItem.style.width = rect.width + 'px';
                    touchItem.classList.add('dragging');
                }
            }, {passive: false});

            document.addEventListener('touchmove', (e) => {
                if (!touchItem) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                touchItem.style.left = (touch.clientX - touchOffset.x) + 'px';
                touchItem.style.top = (touch.clientY - touchOffset.y) + 'px';
                
                const deleteZone = document.getElementById('deleteZone');
                if (touch.clientY > window.innerHeight - 150) {
                    deleteZone.classList.add('active');
                } else {
                    deleteZone.classList.remove('active');
                }
            }, {passive: false});

            document.addEventListener('touchend', (e) => {
                if (!touchItem) return;
                
                const touch = e.changedTouches[0];
                const deleteZone = document.getElementById('deleteZone');
                
                if (touch.clientY > window.innerHeight - 150) {
                    touchItem.remove();
                    showToast('üóëÔ∏è Fiche supprim√©e');
                } else {
                    touchItem.style.display = 'none';
                    const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                    touchItem.style.display = '';
                    
                    const dropZone = elemBelow?.closest('.drop-zone');
                    if (dropZone && !dropZone.classList.contains('read-only')) {
                        const btn = dropZone.querySelector('.add-slot-btn') || dropZone.querySelector('.no-add');
                        dropZone.insertBefore(touchItem, btn);
                        mettreAJourDate(touchItem, dropZone.dataset.status);
                    } else {
                        originalParent.appendChild(touchItem);
                    }
                }
                
                touchItem.style.position = '';
                touchItem.style.zIndex = '';
                touchItem.style.left = '';
                touchItem.style.top = '';
                touchItem.style.width = '';
                touchItem.classList.remove('dragging');
                deleteZone.classList.remove('active');
                
                touchItem = null;
                calculerSynthese();
                calculerStatsDuree();
            });
        }

        function mettreAJourDate(card, newStatus) {
            const today = new Date().toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'});
            const iso = new Date().toISOString().slice(0, 10);
            let datesDiv = card.querySelector('.slot-dates');
            
            if (!datesDiv) {
                datesDiv = document.createElement('div');
                datesDiv.className = 'slot-dates';
                card.insertBefore(datesDiv, card.querySelector('.slot-stickers'));
            }

            let dateDemande = datesDiv.dataset.demande || '';
            let dateDevis = datesDiv.dataset.devis || '';
            let dateEnvoye = datesDiv.dataset.envoye || '';
            let dateSigne = datesDiv.dataset.signe || '';

            if (newStatus === 'demandes' && !dateDemande) { dateDemande = today; datesDiv.dataset.demande = today; datesDiv.dataset.demandeIso = iso; }
            else if (newStatus === 'devis' && !dateDevis) { dateDevis = today; datesDiv.dataset.devis = today; datesDiv.dataset.devisIso = iso; }
            else if (newStatus === 'envoyes' && !dateEnvoye) { dateEnvoye = today; datesDiv.dataset.envoye = today; datesDiv.dataset.envoyeIso = iso; }
            else if (newStatus === 'signes' && !dateSigne) { dateSigne = today; datesDiv.dataset.signe = today; datesDiv.dataset.signeIso = iso; }
            
            let html = '';
            if (dateDemande) html += `<div class="slot-date-item"><span class="slot-date-label">üü° Demand√©:</span> ${dateDemande}</div>`;
            if (dateDevis) html += `<div class="slot-date-item"><span class="slot-date-label">üîµ En cours:</span> ${dateDevis}</div>`;
            if (dateEnvoye) html += `<div class="slot-date-item"><span class="slot-date-label">üü£ Envoy√©:</span> ${dateEnvoye}</div>`;
            if (dateSigne) html += `<div class="slot-date-item"><span class="slot-date-label">üü¢ Sign√©:</span> ${dateSigne}</div>`;
            
            datesDiv.innerHTML = html;
        }

        function makeDraggable(card) {
            card.draggable = true;
            card.addEventListener('dragstart', (e) => {
                draggedCard = card;
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                draggedCard = null;
                document.getElementById('deleteZone').classList.remove('active');
            });
            card.addEventListener('dblclick', () => editerFiche(card));
        }

        // Fonctions existantes
        function chargerDonnees() {
            const saved = localStorage.getItem('obeya_historique_semaines');
            if (saved) historiqueSemaines = JSON.parse(saved);
        }

        function sauvegarderDonnees() {
            localStorage.setItem('obeya_historique_semaines', JSON.stringify(historiqueSemaines));
        }

        function cloturerSemaine() {
            if (!confirm('Cl√¥turer la semaine ? Les fiches vont glisser vers la colonne suivante.')) return;
            effectuerCloture();
            showToast('‚úÖ Semaine cl√¥tur√©e ‚Äî fiches d√©cal√©es');
        }

        // D√©cale toutes les fiches : N‚ÜíN+1, N+1‚ÜíN+2, N+2‚ÜíParking
        function decalerFiches() {
            const statuts = ['demandes', 'devis', 'envoyes', 'signes'];
            const colonnes = ['N', 'N+1', 'N+2', 'parking'];

            for (const statut of statuts) {
                // Parcourir en sens inverse : N+2‚ÜíParking, puis N+1‚ÜíN+2, puis N‚ÜíN+1
                for (let i = colonnes.length - 2; i >= 0; i--) {
                    const source = document.querySelector(`td[data-week="${colonnes[i]}"][data-status="${statut}"]`);
                    const dest = document.querySelector(`td[data-week="${colonnes[i + 1]}"][data-status="${statut}"]`);
                    if (!source || !dest) continue;

                    const cards = source.querySelectorAll('.client-slot');
                    if (cards.length === 0) continue;

                    const anchor = dest.querySelector('.add-slot-btn') || dest.querySelector('.no-add');
                    cards.forEach(card => dest.insertBefore(card, anchor));
                }
            }
        }

        // Effectue la cl√¥ture : archive stats, d√©cale fiches, r√©initialise
        function effectuerCloture() {
            const semaineArchive = {
                numero: currentWeekData.numero,
                debut: currentWeekData.debut,
                fin: currentWeekData.fin,
                demandes: parseInt(document.getElementById('synth-demandes').value) || 0,
                envoyes: parseInt(document.getElementById('synth-envoyes').value) || 0,
                signes: parseInt(document.getElementById('synth-signes').value) || 0,
                euros: parseInt(document.getElementById('synth-euros').value) || 0,
                dateCloture: new Date().toLocaleDateString('fr-FR')
            };

            historiqueSemaines.unshift(semaineArchive);

            // D√©caler toutes les fiches d'une colonne vers la droite
            decalerFiches();

            // R√©initialiser les compteurs
            currentWeekData.demandes = currentWeekData.envoyes = currentWeekData.signes = 0;
            document.getElementById('synth-demandes').value = 0;
            document.getElementById('synth-envoyes').value = 0;
            document.getElementById('synth-signes').value = 0;
            document.getElementById('synth-euros').value = 0;

            // Recalculer les dates pour la semaine courante
            initDates();
            sauvegarderDateSemaine();
            sauvegarderDonnees();
            afficherHistorique();
            calculerSynthese();
            calculerStatsDuree();
        }

        // Sauvegarde la date de fin de semaine active (ISO) pour comparaison auto
        function sauvegarderDateSemaine() {
            const today = new Date();
            const currentDay = today.getDay();
            const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
            const lundi = new Date(new Date().setDate(diff));
            const dimanche = new Date(lundi);
            dimanche.setDate(lundi.getDate() + 6);
            localStorage.setItem('obeya_semaine_fin_iso', dimanche.toISOString().split('T')[0]);
            localStorage.setItem('obeya_semaine_numero', currentWeekData.numero.toString());
        }

        // V√©rifie au chargement si la semaine active est d√©pass√©e
        function verifierClotureSemaine() {
            const savedEndDate = localStorage.getItem('obeya_semaine_fin_iso');
            if (!savedEndDate) {
                // Premier lancement : sauvegarder la date de fin de cette semaine
                sauvegarderDateSemaine();
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(savedEndDate + 'T00:00:00');

            if (today > endDate) {
                // Calculer combien de semaines se sont √©coul√©es
                const diffMs = today - endDate;
                const semainesPasses = Math.ceil(diffMs / (7 * 24 * 60 * 60 * 1000));
                // Plafonner √† 3 d√©calages (au-del√†, tout est en parking de toute fa√ßon)
                const nbDecalages = Math.min(semainesPasses, 3);

                for (let i = 0; i < nbDecalages; i++) {
                    decalerFiches();
                }

                // Archiver la semaine pr√©c√©dente
                const savedNumero = parseInt(localStorage.getItem('obeya_semaine_numero')) || currentWeekData.numero;
                const semaineArchive = {
                    numero: savedNumero,
                    debut: currentWeekData.debut,
                    fin: currentWeekData.fin,
                    demandes: parseInt(document.getElementById('synth-demandes').value) || 0,
                    envoyes: parseInt(document.getElementById('synth-envoyes').value) || 0,
                    signes: parseInt(document.getElementById('synth-signes').value) || 0,
                    euros: parseInt(document.getElementById('synth-euros').value) || 0,
                    dateCloture: new Date().toLocaleDateString('fr-FR')
                };
                historiqueSemaines.unshift(semaineArchive);

                // R√©initialiser
                currentWeekData.demandes = currentWeekData.envoyes = currentWeekData.signes = 0;
                document.getElementById('synth-demandes').value = 0;
                document.getElementById('synth-envoyes').value = 0;
                document.getElementById('synth-signes').value = 0;
                document.getElementById('synth-euros').value = 0;

                initDates();
                sauvegarderDateSemaine();
                sauvegarderDonnees();
                afficherHistorique();
                calculerSynthese();
                calculerStatsDuree();

                showToast(`üìÖ ${semainesPasses} semaine${semainesPasses > 1 ? 's' : ''} √©coul√©e${semainesPasses > 1 ? 's' : ''} ‚Äî fiches d√©cal√©es automatiquement`);
            }
        }

        function afficherHistorique() {
            const container = document.getElementById('historique-container');
            container.innerHTML = '';
            
            if (historiqueSemaines.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #95a5a6; padding: 20px;">Aucune semaine cl√¥tur√©e</div>';
                return;
            }
            
            historiqueSemaines.forEach((semaine) => {
                const taux = semaine.demandes > 0 ? Math.round((semaine.signes / semaine.demandes) * 100) : 0;
                const div = document.createElement('div');
                div.className = 'historique-week';
                div.innerHTML = `
                    <div class="historique-week-header">
                        <span>Semaine ${semaine.numero}</span>
                        <span class="historique-week-date">${semaine.debut} - ${semaine.fin}</span>
                    </div>
                    <div class="historique-stats">
                        <div class="historique-stat"><div class="historique-stat-value">${semaine.demandes}</div><div class="historique-stat-label">Demand√©s</div></div>
                        <div class="historique-stat"><div class="historique-stat-value">${semaine.envoyes}</div><div class="historique-stat-label">Envoy√©s</div></div>
                        <div class="historique-stat"><div class="historique-stat-value">${semaine.signes}</div><div class="historique-stat-label">Sign√©s</div></div>
                        <div class="historique-stat"><div class="historique-stat-value">${semaine.euros}‚Ç¨</div><div class="historique-stat-label">CA</div></div>
                    </div>
                    <div class="historique-taux">Taux de conversion : <strong>${taux}%</strong></div>
                `;
                container.appendChild(div);
            });
        }

        function calculerStatsDuree() {
            const cardsSignees = document.querySelectorAll('[data-status="signes"] .client-slot');
            const durees = [];

            cardsSignees.forEach(card => {
                const datesDiv = card.querySelector('.slot-dates');
                if (datesDiv) {
                    // Prefer ISO dates for accurate calculation, fallback to dd/mm parsing
                    const d1 = datesDiv.dataset.demandeIso ? new Date(datesDiv.dataset.demandeIso) : parseDateFr(datesDiv.dataset.demande);
                    const d2 = datesDiv.dataset.signeIso ? new Date(datesDiv.dataset.signeIso) : parseDateFr(datesDiv.dataset.signe);
                    if (d1 && d2) durees.push(Math.max(0, Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24))));
                }
            });
            
            if (durees.length === 0) {
                ['duree-min', 'duree-max', 'duree-moyenne', 'duree-mediane'].forEach(id => document.getElementById(id).textContent = '-');
                document.getElementById('nb-dossiers-signes').textContent = '0';
                return;
            }
            
            document.getElementById('duree-min').textContent = Math.min(...durees) + 'j';
            document.getElementById('duree-max').textContent = Math.max(...durees) + 'j';
            document.getElementById('duree-moyenne').textContent = (durees.reduce((a, b) => a + b, 0) / durees.length).toFixed(1);
            document.getElementById('duree-mediane').textContent = calculerMediane(durees) + 'j';
            document.getElementById('nb-dossiers-signes').textContent = durees.length;
        }

        function parseDateFr(str) {
            if (!str) return null;
            const [d, m, y] = str.split('/').map(Number);
            return new Date(y ? y + 2000 : new Date().getFullYear(), m - 1, d);
        }

        function calculerMediane(arr) {
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : ((sorted[mid - 1] + sorted[mid]) / 2).toFixed(1);
        }

        function calculerSynthese() {
            const d = document.querySelectorAll('[data-status="demandes"] .client-slot').length;
            const e = document.querySelectorAll('[data-status="envoyes"] .client-slot').length;
            const s = document.querySelectorAll('[data-status="signes"] .client-slot').length;
            
            if (d > currentWeekData.demandes) currentWeekData.demandes = d;
            if (e > currentWeekData.envoyes) currentWeekData.envoyes = e;
            if (s > currentWeekData.signes) currentWeekData.signes = s;
            
            document.getElementById('synth-demandes').value = currentWeekData.demandes;
            document.getElementById('synth-envoyes').value = currentWeekData.envoyes;
            document.getElementById('synth-signes').value = currentWeekData.signes;
            // Synchroniser vers Firebase √† chaque changement
            sauvegarderVersFirebase();
        }

        function scannerClientsExistants() {
            document.querySelectorAll('.client-slot').forEach(slot => {
                const nom = slot.querySelector('.slot-name')?.textContent;
                if (nom && !clients.find(c => c.nom === nom)) {
                    clients.push({nom, element: slot});
                    makeDraggable(slot);
                }
            });
        }

        // Modal
        function ouvrirModal(status, week) {
            if (week !== 'N' && week !== 'parking') {
                showToast('Ajout uniquement en Semaine N ou Parking');
                return;
            }
            currentStatus = status;
            currentWeek = week;
            editingCard = null;
            selectedStickers = [];
            document.getElementById('modalTitle').textContent = 'üìù Nouvelle fiche';
            document.getElementById('fiche-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('btnDelete').style.display = 'none';
            document.querySelectorAll('.sticker-option').forEach(s => s.classList.remove('selected'));
            document.getElementById('modal').classList.add('active');
        }

        function editerFiche(card) {
            editingCard = card;
            selectedStickers = [];
            document.getElementById('modalTitle').textContent = '‚úèÔ∏è Modifier';
            document.getElementById('btnDelete').style.display = 'inline-block';
            
            const name = card.querySelector('.slot-name').textContent;
            const typeText = card.querySelector('.slot-type').textContent;
            const match = typeText.match(/(PART|PRO) - (.+)/);
            const notes = card.querySelector('.slot-notes')?.textContent || '';
            
            document.getElementById('client-name').value = name;
            document.getElementById('client-notes').value = notes;
            if (match) {
                document.getElementById('client-cat').value = match[1];
                document.getElementById('client-type').value = match[2];
            }
            
            const existing = [];
            card.querySelectorAll('.mini-sticker').forEach(s => {
                const bg = window.getComputedStyle(s).backgroundColor;
                for (let [color, hex] of Object.entries(stickerColors)) {
                    if (bg.includes(hex) || bg === `rgb(${hexToRgb(hex)})`) existing.push(color);
                }
            });
            
            document.querySelectorAll('.sticker-option').forEach(opt => {
                opt.classList.toggle('selected', existing.includes(opt.dataset.color));
                if (existing.includes(opt.dataset.color)) selectedStickers.push(opt.dataset.color);
            });
            
            document.getElementById('modal').classList.add('active');
        }

        function hexToRgb(hex) {
            return `${parseInt(hex.slice(1,3),16)}, ${parseInt(hex.slice(3,5),16)}, ${parseInt(hex.slice(5,7),16)}`;
        }

        function toggleSticker(el) {
            const color = el.dataset.color;
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                selectedStickers = selectedStickers.filter(s => s !== color);
            } else {
                el.classList.add('selected');
                selectedStickers.push(color);
            }
        }

        function fermerModal() {
            document.getElementById('modal').classList.remove('active');
            editingCard = null;
            selectedStickers = [];
        }

        function supprimerFiche() {
            if (!editingCard || !confirm('Supprimer ?')) return;
            editingCard.remove();
            calculerSynthese();
            calculerStatsDuree();
            fermerModal();
            showToast('üóëÔ∏è Supprim√©');
        }

        function saveForm(e) {
            e.preventDefault();
            const name = document.getElementById('client-name').value;
            const type = document.getElementById('client-type').value;
            const cat = document.getElementById('client-cat').value;
            const notes = document.getElementById('client-notes').value;
            const stickersHtml = selectedStickers.map(c => `<div class="mini-sticker" style="background:${stickerColors[c]}"></div>`).join('');
            const datesHtml = creerDatesHtml(currentStatus);
            
            if (editingCard) {
                editingCard.querySelector('.slot-name').textContent = name;
                editingCard.querySelector('.slot-type').textContent = `${cat} - ${type}`;
                let notesEl = editingCard.querySelector('.slot-notes');
                if (notes) {
                    if (!notesEl) {
                        notesEl = document.createElement('div');
                        notesEl.className = 'slot-notes';
                        editingCard.insertBefore(notesEl, editingCard.querySelector('.slot-stickers'));
                    }
                    notesEl.textContent = notes;
                } else if (notesEl) notesEl.remove();
                
                let stickersContainer = editingCard.querySelector('.slot-stickers');
                if (!stickersContainer) {
                    stickersContainer = document.createElement('div');
                    stickersContainer.className = 'slot-stickers';
                    editingCard.appendChild(stickersContainer);
                }
                stickersContainer.innerHTML = stickersHtml;
                showToast('‚úÖ Modifi√©');
            } else {
                const card = document.createElement('div');
                card.className = 'client-slot new';
                card.draggable = true;
                let html = `
                    <div class="slot-header"><span class="slot-name">${name}</span><span class="slot-edit no-print">‚úèÔ∏è</span></div>
                    <div class="slot-type">${cat} - ${type}</div>
                `;
                if (notes) html += `<div class="slot-notes">${notes}</div>`;
                html += datesHtml + `<div class="slot-stickers">${stickersHtml}</div>`;
                card.innerHTML = html;
                makeDraggable(card);
                card.querySelector('.slot-edit').addEventListener('click', (e) => { e.stopPropagation(); editerFiche(card); });
                
                const cell = document.querySelector(`td[data-week="${currentWeek}"][data-status="${currentStatus}"]`);
                cell.insertBefore(card, cell.querySelector('.add-slot-btn'));
                clients.push({nom: name, element: card});
                showToast('‚úÖ Cr√©√©');
            }
            
            calculerSynthese();
            calculerStatsDuree();
            fermerModal();
        }

        function creerDatesHtml(status) {
            const today = new Date().toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'});
            const iso = new Date().toISOString().slice(0, 10);
            let html = '<div class="slot-dates"', d = '', de = '', en = '', s = '';
            if (status === 'demandes') { d = today; html += ` data-demande="${today}" data-demande-iso="${iso}"`; }
            else if (status === 'devis') { d = de = today; html += ` data-demande="${today}" data-demande-iso="${iso}" data-devis="${today}" data-devis-iso="${iso}"`; }
            else if (status === 'envoyes') { d = en = today; html += ` data-demande="${today}" data-demande-iso="${iso}" data-envoye="${today}" data-envoye-iso="${iso}"`; }
            else if (status === 'signes') { d = s = today; html += ` data-demande="${today}" data-demande-iso="${iso}" data-signe="${today}" data-signe-iso="${iso}"`; }
            html += '>';
            if (d) html += `<div class="slot-date-item"><span class="slot-date-label">üü° Demand√©:</span> ${d}</div>`;
            if (de) html += `<div class="slot-date-item"><span class="slot-date-label">üîµ En cours:</span> ${de}</div>`;
            if (en) html += `<div class="slot-date-item"><span class="slot-date-label">üü£ Envoy√©:</span> ${en}</div>`;
            if (s) html += `<div class="slot-date-item"><span class="slot-date-label">üü¢ Sign√©:</span> ${s}</div>`;
            return html + '</div>';
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function imprimer() {
            window.print();
        }

        function showHelp() {
            alert(`üéôÔ∏è COMMANDES VOCALES:

1. "Nouveau client [Nom] [Type] [Cat]"
   Ex: "Nouveau client Dupont Auto Particulier"

2. "Note √† [Nom] : [texte]"
   Ex: "Note √† Dupont : relancer demain"

3. "D√©placer [Nom] vers [statut]"
   Ex: "D√©placer Dupont vers sign√©s"

üí° INTERACTIONS:
‚Ä¢ Glisser-d√©poser souris/touch
‚Ä¢ Double-clic pour modifier
‚Ä¢ Glisser vers bas = supprimer

üì± INSTALLATION:
iOS: Partager ‚Üí "Sur l'√©cran d'accueil"
Android: Menu ‚ãÆ ‚Üí "Ajouter √† l'√©cran d'accueil"`);
        }

        // ================================================
        // === FIREBASE - Synchronisation temps r√©el ===
        // ================================================

        async function initFirebase() {
            try {
                const appModule = await import('https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js');
                const fsModule = await import('https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js');

                const app = appModule.initializeApp(firebaseConfig);
                firebaseDb = fsModule.getFirestore(app);
                firebaseModules = fsModule;

                ecouterFirebase();
                updateSyncStatus('connected');
                console.log('Firebase: connect√©');
            } catch (err) {
                console.error('Firebase init error:', err);
                updateSyncStatus('offline');
            }
        }

        // S√©rialiser toutes les fiches du tableau en objets
        function serializerTableau() {
            const cards = [];
            document.querySelectorAll('.client-slot').forEach(card => {
                const cell = card.closest('td');
                if (!cell) return;
                const datesDiv = card.querySelector('.slot-dates');
                const stickers = [];
                card.querySelectorAll('.mini-sticker').forEach(s => {
                    const style = s.getAttribute('style') || '';
                    for (const [name, hex] of Object.entries(stickerColors)) {
                        if (style.includes(hex)) stickers.push(name);
                    }
                });

                cards.push({
                    nom: card.querySelector('.slot-name')?.textContent || '',
                    type: card.querySelector('.slot-type')?.textContent || '',
                    notes: card.querySelector('.slot-notes')?.textContent || '',
                    stickers: stickers,
                    dates: {
                        demande: datesDiv?.dataset.demande || '',
                        demandeIso: datesDiv?.dataset.demandeIso || '',
                        devis: datesDiv?.dataset.devis || '',
                        devisIso: datesDiv?.dataset.devisIso || '',
                        envoye: datesDiv?.dataset.envoye || '',
                        envoyeIso: datesDiv?.dataset.envoyeIso || '',
                        signe: datesDiv?.dataset.signe || '',
                        signeIso: datesDiv?.dataset.signeIso || ''
                    },
                    week: cell.dataset.week || 'N',
                    status: cell.dataset.status || 'demandes'
                });
            });
            return cards;
        }

        // Recr√©er toutes les fiches √† partir des donn√©es Firebase
        function deserialiserTableau(cardsData) {
            document.querySelectorAll('.client-slot').forEach(c => c.remove());
            clients = [];
            if (!cardsData || !Array.isArray(cardsData)) return;

            cardsData.forEach(data => {
                const card = document.createElement('div');
                card.className = 'client-slot';
                card.draggable = true;

                let html = `<div class="slot-header"><span class="slot-name">${data.nom}</span><span class="slot-edit no-print">‚úèÔ∏è</span></div>`;
                html += `<div class="slot-type">${data.type}</div>`;
                if (data.notes) html += `<div class="slot-notes">${data.notes}</div>`;

                const d = data.dates || {};
                html += '<div class="slot-dates"';
                if (d.demande) html += ` data-demande="${d.demande}"`;
                if (d.demandeIso) html += ` data-demande-iso="${d.demandeIso}"`;
                if (d.devis) html += ` data-devis="${d.devis}"`;
                if (d.devisIso) html += ` data-devis-iso="${d.devisIso}"`;
                if (d.envoye) html += ` data-envoye="${d.envoye}"`;
                if (d.envoyeIso) html += ` data-envoye-iso="${d.envoyeIso}"`;
                if (d.signe) html += ` data-signe="${d.signe}"`;
                if (d.signeIso) html += ` data-signe-iso="${d.signeIso}"`;
                html += '>';
                if (d.demande) html += `<div class="slot-date-item"><span class="slot-date-label">üü° Demand√©:</span> ${d.demande}</div>`;
                if (d.devis) html += `<div class="slot-date-item"><span class="slot-date-label">üîµ En cours:</span> ${d.devis}</div>`;
                if (d.envoye) html += `<div class="slot-date-item"><span class="slot-date-label">üü£ Envoy√©:</span> ${d.envoye}</div>`;
                if (d.signe) html += `<div class="slot-date-item"><span class="slot-date-label">üü¢ Sign√©:</span> ${d.signe}</div>`;
                html += '</div>';

                html += '<div class="slot-stickers">';
                (data.stickers || []).forEach(c => {
                    if (stickerColors[c]) html += `<div class="mini-sticker" style="background:${stickerColors[c]}"></div>`;
                });
                html += '</div>';

                card.innerHTML = html;
                makeDraggable(card);
                card.querySelector('.slot-edit')?.addEventListener('click', (e) => { e.stopPropagation(); editerFiche(card); });

                const cell = document.querySelector(`td[data-week="${data.week}"][data-status="${data.status}"]`);
                if (cell) {
                    const anchor = cell.querySelector('.add-slot-btn') || cell.querySelector('.no-add');
                    cell.insertBefore(card, anchor);
                }

                clients.push({ nom: data.nom, element: card });
            });
        }

        // Sauvegarde vers Firebase (debounce 500ms)
        function sauvegarderVersFirebase() {
            if (!firebaseDb || isLoadingFromFirebase) return;

            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                lastSavedVersion = Math.random().toString(36).substring(2, 10);
                const data = {
                    cards: serializerTableau(),
                    historique: historiqueSemaines,
                    weekData: {
                        numero: currentWeekData.numero,
                        debut: currentWeekData.debut,
                        fin: currentWeekData.fin,
                        demandes: currentWeekData.demandes,
                        envoyes: currentWeekData.envoyes,
                        signes: currentWeekData.signes,
                        euros: parseInt(document.getElementById('synth-euros').value) || 0
                    },
                    semaineFinIso: localStorage.getItem('obeya_semaine_fin_iso') || '',
                    version: lastSavedVersion
                };

                // Aussi sauvegarder en localStorage (fallback offline)
                localStorage.setItem('obeya_cards', JSON.stringify(data.cards));

                firebaseModules.setDoc(
                    firebaseModules.doc(firebaseDb, 'obeya', 'board'),
                    data
                ).then(() => {
                    updateSyncStatus('synced');
                    console.log('Firebase: sauvegard√©');
                }).catch(err => {
                    console.error('Firebase save error:', err);
                    updateSyncStatus('error');
                });
            }, 500);
        }

        // √âcouter les changements en temps r√©el depuis Firebase
        function ecouterFirebase() {
            if (!firebaseDb) return;

            const docRef = firebaseModules.doc(firebaseDb, 'obeya', 'board');

            firebaseModules.onSnapshot(docRef, (snapshot) => {
                if (!snapshot.exists()) {
                    // Premier lancement : pousser les donn√©es locales vers Firebase
                    console.log('Firebase: document vide, initialisation...');
                    // Charger les fiches depuis localStorage si disponible
                    const localCards = localStorage.getItem('obeya_cards');
                    if (localCards) {
                        try { deserialiserTableau(JSON.parse(localCards)); } catch(e) {}
                    }
                    sauvegarderVersFirebase();
                    return;
                }

                const data = snapshot.data();

                // Ignorer notre propre √©cho
                if (data.version === lastSavedVersion) {
                    return;
                }

                console.log('Firebase: donn√©es re√ßues d\'un autre appareil');
                isLoadingFromFirebase = true;

                // Restaurer historique
                if (data.historique) {
                    historiqueSemaines = data.historique;
                    localStorage.setItem('obeya_historique_semaines', JSON.stringify(historiqueSemaines));
                    afficherHistorique();
                }

                // Restaurer weekData
                if (data.weekData) {
                    currentWeekData = { ...currentWeekData, ...data.weekData };
                    document.getElementById('num-semaine').value = currentWeekData.numero;
                    document.getElementById('date-debut').value = currentWeekData.debut;
                    document.getElementById('date-fin').value = currentWeekData.fin;
                    document.getElementById('synth-demandes').value = currentWeekData.demandes;
                    document.getElementById('synth-envoyes').value = currentWeekData.envoyes;
                    document.getElementById('synth-signes').value = currentWeekData.signes;
                    if (data.weekData.euros !== undefined) {
                        document.getElementById('synth-euros').value = data.weekData.euros;
                    }
                }

                if (data.semaineFinIso) {
                    localStorage.setItem('obeya_semaine_fin_iso', data.semaineFinIso);
                }

                // Restaurer les fiches
                if (data.cards) {
                    deserialiserTableau(data.cards);
                    localStorage.setItem('obeya_cards', JSON.stringify(data.cards));
                }

                calculerStatsDuree();
                isLoadingFromFirebase = false;
                updateSyncStatus('synced');
                showToast('üîÑ Tableau synchronis√©');
            }, (err) => {
                console.error('Firebase listen error:', err);
                updateSyncStatus('error');
            });
        }

        // Indicateur visuel de synchronisation
        function updateSyncStatus(status) {
            let indicator = document.getElementById('syncIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'syncIndicator';
                indicator.style.cssText = 'position:fixed;top:10px;right:10px;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;z-index:999;transition:all 0.3s;';
                document.body.appendChild(indicator);
            }
            switch (status) {
                case 'connected':
                    indicator.textContent = 'üîÑ Connexion...';
                    indicator.style.background = '#ffeaa7';
                    indicator.style.color = '#2d3436';
                    break;
                case 'synced':
                    indicator.textContent = '‚úÖ Synchronis√©';
                    indicator.style.background = '#00b894';
                    indicator.style.color = 'white';
                    setTimeout(() => { indicator.style.opacity = '0.4'; }, 2000);
                    break;
                case 'error':
                    indicator.textContent = '‚ö†Ô∏è Erreur sync';
                    indicator.style.background = '#d63031';
                    indicator.style.color = 'white';
                    indicator.style.opacity = '1';
                    break;
                case 'offline':
                    indicator.textContent = 'üì¥ Hors-ligne';
                    indicator.style.background = '#636e72';
                    indicator.style.color = 'white';
                    indicator.style.opacity = '0.6';
                    break;
            }
            if (status !== 'synced') indicator.style.opacity = '1';
        }

        // Charger les fiches depuis localStorage au d√©marrage (fallback offline)
        function chargerFichesLocales() {
            const localCards = localStorage.getItem('obeya_cards');
            if (localCards) {
                try {
                    deserialiserTableau(JSON.parse(localCards));
                } catch(e) {
                    console.error('Erreur chargement fiches locales:', e);
                }
            }
        }

        // Gestion micro hint
        const micBtn = document.getElementById('micBtn');
        micBtn.addEventListener('mouseenter', () => document.getElementById('micHint').classList.add('visible'));
        micBtn.addEventListener('mouseleave', () => document.getElementById('micHint').classList.remove('visible'));
        micBtn.addEventListener('touchstart', () => document.getElementById('micHint').classList.add('visible'));
        micBtn.addEventListener('touchend', () => setTimeout(() => document.getElementById('micHint').classList.remove('visible'), 2000));
    </script>
</body>
</html>
